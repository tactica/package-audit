require_relative '../enum/vulnerability_type'

module Package
  module Audit
    module Ruby
      class VulnerabilityFinder
        def self.run
          @gems = {}
          json_str = `bundle exec bundle-audit check --update --quiet --format json`
          json_results = JSON.parse(json_str, symbolize_names: true)[:results]
          json_results.each do |result|
            gem_name = result[:gem][:name]
            @gems[gem_name] = Dependency.new result[:gem][:name], result[:gem][:version] unless @gems.key? gem_name
            @gems[gem_name].update vulnerabilities: @gems[gem_name].vulnerabilities + [result[:advisory][:criticality] || Enum::VulnerabilityType::UNKNOWN]
          end
          @gems.values
        end
      end
    end
  end
end
