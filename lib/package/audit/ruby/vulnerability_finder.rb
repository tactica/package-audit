require_relative '../enum/vulnerability_type'

module Package
  module Audit
    module Ruby
      class VulnerabilityFinder
        def self.run # rubocop:disable Metrics/AbcSize
          gem_hash = {}
          json_str = `bundle exec bundle-audit check --update --quiet --format json`
          json_results = JSON.parse(json_str, symbolize_names: true)[:results]
          json_results.each do |result|
            gem_name = result[:gem][:name]
            vulnerability = result[:advisory][:criticality] || Enum::VulnerabilityType::UNKNOWN
            unless gem_hash.key? gem_name
              gem_hash[gem_name] = Dependency.new result[:gem][:name], result[:gem][:version]
            end
            gem_hash[gem_name].update vulnerabilities: gem_hash[gem_name].vulnerabilities + [vulnerability]
          end
          gem_hash.values
        end
      end
    end
  end
end
