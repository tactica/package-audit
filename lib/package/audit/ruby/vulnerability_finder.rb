require_relative '../const'
require_relative '../enum/vulnerability_type'

module Package
  module Audit
    module Ruby
      class VulnerabilityFinder
        def initialize
          @vuln_hash = {}
        end

        def run
          json_result = `#{Const::BUNDLE_AUDIT_CMD_JSON}`
          vulnerability_json_array = JSON.parse(json_result, symbolize_names: true)[:results]
          vulnerability_json_array.each do |vulnerability_json|
            name, version, full_name, vulnerability = extract_data_from_json(vulnerability_json)
            @vuln_hash[full_name] = Package.new name, version unless @vuln_hash.key? full_name
            @vuln_hash[full_name].update vulnerabilities: @vuln_hash[full_name].vulnerabilities + [vulnerability]
          end
          @vuln_hash.values
        end

        private

        def extract_data_from_json(json)
          name = json[:gem][:name]
          version = json[:gem][:version]
          full_name = "#{name}@#{version}"
          vulnerability = json[:advisory][:criticality] || Enum::VulnerabilityType::UNKNOWN
          [name, version, full_name, vulnerability]
        end
      end
    end
  end
end
