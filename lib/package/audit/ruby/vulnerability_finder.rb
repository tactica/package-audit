require_relative '../enum/vulnerability_type'

module Package
  module Audit
    module Ruby
      class VulnerabilityFinder
        def self.gems(dir)
          json_str = `bundle exec bundle-audit check #{dir} --update --quiet --format json`
          json_results = JSON.parse(json_str, symbolize_names: true)[:results]
          json_results.map do |result|
            gem = Dependency.new result[:gem][:name], result[:gem][:version]
            gem.update vulnerability: result[:advisory][:criticality] || Enum::VulnerabilityType::UNKNOWN
            gem
          end
        end
      end
    end
  end
end
