require_relative '../const'
require_relative '../enum/vulnerability_type'

module Package
  module Audit
    module Npm
      class VulnerabilityFinder
        AUDIT_ADVISORY_REGEX = /^{"type":"auditAdvisory".*$/

        def initialize(pkgs)
          @pkg_hash = pkgs.to_h { |pkg| [pkg.name, pkg] }
          @vuln_hash = {}
        end

        def run
          json_string_lines = `#{Const::YARN_AUDIT_CMD_JSON}`
          array = json_string_lines.scan(AUDIT_ADVISORY_REGEX)

          vulnerability_json_array = JSON.parse("[#{array.join(',')}]", symbolize_names: true)
          vulnerability_json_array.each do |vulnerability_json|
            parent_name = vulnerability_json[:data][:resolution][:path].split('>').first
            name, version, full_name, vulnerability = extract_data_from_json(vulnerability_json)
            update_meta_data(name, full_name, parent_name, version, vulnerability)
          end
          @vuln_hash.values
        end

        private

        def update_meta_data(name, full_name, parent_name, version, vulnerability)
          @vuln_hash[full_name] = Package.new name, version unless @vuln_hash.key? full_name
          @vuln_hash[full_name].update vulnerabilities: @vuln_hash[full_name].vulnerabilities + [vulnerability]
          @vuln_hash[full_name].update groups: @pkg_hash[parent_name].groups
        end

        def extract_data_from_json(json)
          advisory = json[:data][:advisory]
          name = advisory[:module_name]
          version = advisory[:findings][0][:version]
          full_name = "#{name}@#{version}"
          vulnerability = advisory[:severity] || Enum::VulnerabilityType::UNKNOWN
          [name, version, full_name, vulnerability]
        end
      end
    end
  end
end
